<Page x:Class="Pract15.Glavn"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:Pract15" 
      xmlns:validators="clr-namespace:Pract15.Validstors"
      DataContext="{Binding RelativeSource={RelativeSource Self}}"
      Background="{StaticResource BackgroundBrush}"
      Height="800"
      Title="Главная страница">
    <Grid Margin="15">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="260"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Кнопки управления -->
        <StackPanel x:Name="ButtonsPanel" 
            Grid.Row="0" 
            Grid.ColumnSpan="2"
            Orientation="Horizontal" 
            HorizontalAlignment="Left"
            Margin="0,0,0,15">
            <Button Style="{StaticResource AddButton}" Click="Button_Click" Margin="0,0,8,0" Padding="12,8">Добавить товар</Button>
            <Button Style="{StaticResource AddButton}" Click="Button_Click_1" Margin="0,0,8,0" Padding="12,8">Добавить категории</Button>
            <Button Style="{StaticResource AddButton}" Click="Button_Click_2" Margin="0,0,8,0" Padding="12,8">Добавить теги</Button>
            <Button Style="{StaticResource AddButton}" Click="Button_Click_3" Padding="12,8">Добавить бренды</Button>

            <!-- Кнопка удаления товара (только для менеджера) -->
            <Button x:Name="btnDeleteSelected"
                    Style="{StaticResource DeleteButton}"
                    Click="DeleteSelected_Click"
                    IsEnabled="{Binding SelectedItem, ElementName=ProductsList}"
                    Margin="0,0,0,0"
                    Padding="12,8"
                    Visibility="{Binding isManager, Converter={StaticResource BooleanToVisibilityConverter}}">
                Удалить товар
            </Button>
        </StackPanel>

        <!-- Поиск -->
        <StackPanel Grid.Row="1" Grid.ColumnSpan="2" Margin="0,0,0,15">
            <Label FontSize="18" Foreground="{StaticResource TextBrush}" FontWeight="SemiBold">Поиск</Label>
            <TextBox x:Name="txtSearch"
                     Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                     Style="{StaticResource Text}"
                     Margin="0,8,0,0"
                     Height="35"
                     FontSize="14"
                     Width="600"/>
        </StackPanel>

        <!-- Панель фильтров -->
        <Border Grid.Row="2" Grid.Column="0" 
                Background="{StaticResource WhiteBrush}" 
                CornerRadius="8" 
                Margin="0,0,10,0" 
                Padding="12"
                BorderThickness="1"
                BorderBrush="{StaticResource BackgroundBrush}">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <Label FontSize="16" Foreground="{StaticResource TextBrush}" FontWeight="SemiBold" Margin="0,0,0,8">Сортировка</Label>
                    <ComboBox x:Name="cmbSort" 
                              Style="{StaticResource MaterialDesignComboBox}"
                              FontSize="13"
                              Height="32"
                              SelectionChanged="ComboBox_SelectionChanged"
                              Margin="0,0,0,15">
                        <ComboBoxItem Tag="NameAsc">По наименованию А</ComboBoxItem>
                        <ComboBoxItem Tag="NameDesc">По наименованию Я</ComboBoxItem>
                        <ComboBoxItem Tag="PriceAsc">По цене (возрастание)</ComboBoxItem>
                        <ComboBoxItem Tag="PriceDesc">По цене (убывание)</ComboBoxItem>
                        <ComboBoxItem Tag="StockAsc">По количеству (возрастание)</ComboBoxItem>
                        <ComboBoxItem Tag="StockDesc">По количеству (убывание)</ComboBoxItem>
                    </ComboBox>

                    <Label FontSize="16" Margin="0,0,0,8" Foreground="{StaticResource TextBrush}" FontWeight="SemiBold">Фильтры</Label>

                    <StackPanel Margin="0,0,0,12">
                        <Label FontSize="14" Foreground="{StaticResource TextBrush}" Margin="0,0,0,5">Категория</Label>
                        <ComboBox x:Name="cmbCategoryFilter" 
                                  Style="{StaticResource MaterialDesignComboBox}"
                                  FontSize="13"
                                  Height="32"/>
                    </StackPanel>

                    <StackPanel Margin="0,0,0,12">
                        <Label FontSize="14" Foreground="{StaticResource TextBrush}" Margin="0,0,0,5">Бренд</Label>
                        <ComboBox x:Name="cmbBrandFilter" 
                                  Style="{StaticResource MaterialDesignComboBox}"
                                  FontSize="13"
                                  Height="32"/>
                    </StackPanel>

                    <StackPanel Margin="0,0,0,15">
                        <Label FontSize="14" Foreground="{StaticResource TextBrush}" Margin="0,0,0,5">Фильтр по цене</Label>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" 
                   VerticalAlignment="Center" 
                   Foreground="{StaticResource TextBrush}"
                   FontSize="13"
                   Margin="0,0,8,0">от:</TextBlock>

                            <!-- Поле "от" -->
                            <TextBox x:Name="txtPriceFrom" 
                 Grid.Row="0" Grid.Column="1"
                 Style="{StaticResource ValidatingTextBoxStyle}"
                 Width="80"
                 Height="40"
                 FontSize="13">
                                <TextBox.Text>
                                    <Binding Path="FilterPriceFrom" 
                         UpdateSourceTrigger="LostFocus" 
                         NotifyOnValidationError="True">
                                        <Binding.ValidationRules>
                                            <validators:PriceRangeValid/>
                                        </Binding.ValidationRules>
                                    </Binding>
                                </TextBox.Text>
                            </TextBox>

                            <TextBlock Grid.Row="0" Grid.Column="2" 
                   VerticalAlignment="Center" 
                   Foreground="{StaticResource TextBrush}"
                   FontSize="13"
                   Margin="15,0,8,0">до:</TextBlock>

                            <!-- Поле "до" -->
                            <TextBox x:Name="txtPriceTo" 
                 Grid.Row="0" Grid.Column="3"
                 Style="{StaticResource ValidatingTextBoxStyle}"
                 Width="80"
                 Height="40"
                 FontSize="13">
                                <TextBox.Text>
                                    <Binding Path="FilterPriceTo" 
                         UpdateSourceTrigger="LostFocus" 
                         NotifyOnValidationError="True">
                                        <Binding.ValidationRules>
                                            <validators:PriceRangeValid/>
                                        </Binding.ValidationRules>
                                    </Binding>
                                </TextBox.Text>
                            </TextBox>

                            <!-- Ошибка для поля "от" -->
                            <TextBlock Grid.Row="1" Grid.Column="1"
                               Foreground="Red"
                               FontSize="11"
                               Margin="0,2,0,0">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value=""/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding ElementName=txtPriceFrom, Path=(Validation.HasError)}" Value="True">
                                                <Setter Property="Text" 
                                                        Value="{Binding ElementName=txtPriceFrom, Path=(Validation.Errors)[0].ErrorContent}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>

                            <!-- Ошибка для поля "до" -->
                            <TextBlock Grid.Row="1" Grid.Column="3"
                               Foreground="Red"
                               FontSize="11"
                               Margin="0,2,0,0">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value=""/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding ElementName=txtPriceTo, Path=(Validation.HasError)}" Value="True">
                                                <Setter Property="Text" 
                                                        Value="{Binding ElementName=txtPriceTo, Path=(Validation.Errors)[0].ErrorContent}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>
                    </StackPanel>

                    <Button x:Name="btnReset"
                            Margin="0,20,0,0" 
                            Style="{StaticResource AddButton}" 
                            FontSize="13"
                            Height="36"
                            Padding="12,6"
                            Click="ResetButton_Click">Сбросить все фильтры</Button>
                </StackPanel>
            </ScrollViewer>
        </Border>

        <Border Grid.Row="2" Grid.Column="1" 
                Background="{StaticResource WhiteBrush}" 
                CornerRadius="8" 
                Padding="15"
                BorderThickness="1"
                BorderBrush="{StaticResource BackgroundBrush}">
            <ListView x:Name="ProductsList"
                      ItemsSource="{Binding prods}" 
                      ScrollViewer.VerticalScrollBarVisibility="Auto"
                      ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                      ScrollViewer.CanContentScroll="True"
                      HorizontalContentAlignment="Stretch"
                      BorderThickness="0"
                      VirtualizingPanel.IsVirtualizing="False">
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <Border Style="{StaticResource LowStockProductStyle}" Margin="0,0,0,10">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0">
                                    <!-- Название товара -->
                                    <TextBlock Text="{Binding Name}" 
                               FontWeight="Bold" 
                               FontSize="18"
                               Foreground="{StaticResource TextBrush}"/>

                                    <!-- Рейтинг -->
                                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                        <TextBlock>
                            <Run Text="🌟"/>
                            <Run Text="Рейтинг: "/>
                            <Run Text="{Binding Rating}" FontWeight="SemiBold"/>
                                        </TextBlock>
                                    </StackPanel>

                                    <!-- Категория под рейтингом -->
                                    <TextBlock Margin="0,4,0,0">
                        <Run Text="Категория: "/>
                        <Run Text="{Binding Category.Name}" FontWeight="SemiBold" Foreground="{StaticResource PrimaryBrush}"/>
                                    </TextBlock>

                                    <!-- ОПИСАНИЕ И ОСТАТОК В ОДНОЙ СТРОКЕ, В РАЗНЫХ КОЛОНКАХ -->
                                    <Grid Margin="0,10,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Описание слева -->
                                        <TextBlock Grid.Column="0" 
                                   Text="{Binding Description}" 
                                   TextWrapping="Wrap"
                                   FontSize="14"
                                   Foreground="{StaticResource TextBrush}"
                                   VerticalAlignment="Center"/>

                                        <!-- Остаток справа -->
                                        <TextBlock Grid.Column="1"
                                   HorizontalAlignment="Right"
                                   Margin="15,0,0,0"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center">
                            <Run Text="Остаток: "/>
                            <Run Text="{Binding Stock}"/>
                            <Run Style="{StaticResource LowStockTextStyle}"/>
                                        </TextBlock>
                                    </Grid>

                                    <!-- Теги -->
                                    <WrapPanel Margin="0,10,0,0">
                                        <ItemsControl ItemsSource="{Binding Tags}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Background="{StaticResource BackgroundBrush}" 
                                            CornerRadius="4" 
                                            Margin="0,0,5,0" 
                                            Padding="8,4">
                                                        <TextBlock Text="{Binding Name, StringFormat='\#{0}'}" 
                                                   FontSize="12"
                                                   Foreground="{StaticResource TextBrush}"/>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </WrapPanel>
                                </StackPanel>

                                <!-- Цена в правом столбце вверху -->
                                <StackPanel Grid.Column="1"
                                            HorizontalAlignment="Right"
                                            VerticalAlignment="Top"
                                            Margin="15,0,0,0">
                                    <!-- Цена -->
                                    <TextBlock FontWeight="Bold" 
                                               FontSize="20"
                                               Foreground="{StaticResource PrimaryBrush}">
                                        <Run Text="{Binding Price, StringFormat={}{0:C}}"/>
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Border>

        <Border Grid.Row="3" Grid.ColumnSpan="2" 
                Background="{StaticResource SecondaryBrush}" 
                CornerRadius="8" 
                Margin="0,15,0,0" 
                Padding="20,12">
            <WrapPanel>
                <TextBlock Text="{Binding prods.Count, StringFormat='{}Всего записей: {0}'}" 
                       Margin="0,0,30,0" 
                       FontSize="14"
                       FontWeight="Bold"
                       Foreground="{StaticResource WhiteBrush}"/>
                <TextBlock Text="{Binding Items.Count, ElementName=ProductsList, StringFormat='{}Показано: {0}'}"
                       FontSize="14"
                       FontWeight="Bold"
                       Foreground="{StaticResource WhiteBrush}"/>
            </WrapPanel>
        </Border>
    </Grid>
</Page>